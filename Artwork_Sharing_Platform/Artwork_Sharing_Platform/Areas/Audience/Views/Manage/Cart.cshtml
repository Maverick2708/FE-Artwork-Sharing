@{
    Layout = "~/Views/Shared/defaultAuthor.cshtml";
}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Home - Pintereso Bootstrap Template</title>
    <script type="text/javascript">(function () { var css = document.createElement('link'); css.href = 'https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css'; css.rel = 'stylesheet'; css.type = 'text/css'; document.getElementsByTagName('head')[0].appendChild(css); })();</script>
    <link href="~/Assets/template-pintereso-bootstrap-html-master/docs/assets/css/app.css" rel="stylesheet" />
    <link href="~/Assets/template-pintereso-bootstrap-html-master/docs/assets/css/theme.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- Link đến Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Link đến jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Link đến Bootstrap JavaScript và các plugin cần thiết -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    
    <style>
        .payment-info {
            background: #1818b1;
            padding: 10px;
            border-radius: 6px;
            color: #fff;
            font-weight: bold;
        }

        .product-details {
            padding: 10px;
        }

        body {
            background: #eee;
        }

        .cart {
            background: #fff;
        }

        .p-about {
            font-size: 12px;
        }

        .table-shadow {
            -webkit-box-shadow: 5px 5px 15px -2px rgba(0,0,0,0.42);
            box-shadow: 5px 5px 15px -2px rgba(0,0,0,0.42);
        }

        .type {
            font-weight: 400;
            font-size: 10px;
        }

        label.radio {
            cursor: pointer;
        }

            label.radio input {
                position: absolute;
                top: 0;
                left: 0;
                visibility: hidden;
                pointer-events: none;
            }

            label.radio span {
                padding: 1px 12px;
                border: 2px solid #ada9a9;
                display: inline-block;
                color: #8f37aa;
                border-radius: 3px;
                text-transform: uppercase;
                font-size: 11px;
                font-weight: 300;
            }

            label.radio input:checked + span {
                border-color: #fff;
                background-color: blue;
                color: #fff;
            }

        .credit-inputs {
            background: rgb(102,102,221);
            color: #fff !important;
            border-color: rgb(102,102,221);
        }

            .credit-inputs::placeholder {
                color: #fff;
                font-size: 13px;
            }

        .credit-card-label {
            font-size: 9px;
            font-weight: 300;
        }

        .form-control.credit-inputs:focus {
            background: rgb(102,102,221);
            border: rgb(102,102,221);
        }

        .line {
            border-bottom: 1px solid rgb(102,102,221);
        }

        .information span {
            font-size: 12px;
            font-weight: 500;
        }

        .information {
            margin-bottom: 5px;
        }

        .items {
            -webkit-box-shadow: 5px 5px 4px -1px rgba(0,0,0,0.25);
            box-shadow: 5px 5px 4px -1px rgba(0, 0, 0, 0.08);
        }

        .spec {
            font-size: 11px;
        }

        .fit-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }
        
        .transparent-button {
            border: 1px solid transparent;
            background-color: transparent;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>

</head>
<body>
    <div class="container mt-5 p-3 rounded cart">
        <div class="row no-gutters">
            <div class="col-md-8">
                <div class="product-details mr-2">
                    <div class="d-flex flex-row align-items-center">
                        <a href="~/Audience/Manage/Manage">
                            <i class="fa fa-long-arrow-left"></i>
                            <span class="ml-2">Continue Shopping</span>
                        </a>
                    </div>
                    <hr>
                    <h6 class="mb-0">Shopping cart</h6>
                    <div class="d-flex justify-content-between">
                        <span id="count-items"></span>
                        <div class="d-flex flex-row align-items-center">
                            <span class="text-black-50">Sort by:</span>
                            <div class="price ml-2"><span class="mr-1">price</span><i class="fa fa-angle-down"></i></div>
                        </div>
                    </div>
                    <div id="apiDataContainer"></div>
                    <script>
                        var userId = sessionStorage.getItem("userId");
                        var totalPrice = 0;
                        $(document).ready(function () {
                            $.ajax({
                                type: 'GET',
                                url: `https://localhost:7008/api/ShoppingCart/user/${userId}`,
                                success: function (response) {
                                    if (response && Array.isArray(response) && response.length > 0) {
                                        // Iterate through each artwork in the response
                                        response.forEach(function (items) {
                                            console.log(items);
                                            (function (items) {
                                                $.ajax({
                                                    type: 'GET',
                                                    url: `https://localhost:7008/api/Arwork/GetArtworkById?artworkid=${items.artworkPId}`,
                                                    success: function (responseName) {
                                                        if (responseName.dataObject) {
                                                            console.log(responseName.dataObject);
                                                            
                                                            
                                                            const strHTML = `
                                        <div class="d-flex justify-content-between align-items-center mt-3 p-2 items rounded">
                                            <div class="d-flex flex-row">
                                                <img class="rounded" src="data:image/png;base64, ${items.pictureArtwork}" width="40">
                                                <div class="ml-2"><span class="font-weight-bold d-block">${responseName.dataObject.contentArtwork}</span>
                                                <span class="spec">${responseName.dataObject.description}</span>
                                                </div>
                                            </div>
                                            <div class="d-flex flex-row align-items-center">
                                                <span class="d-block">${items.quanity}</span>
                                                <span class="d-block ml-5 font-weight-bold">${(items.priceArtwork).toLocaleString('vi-VN') + 'đ'}</span>
                                                <button class="transparent-button" class="btn-icon" onclick="deleteItems('${items.shoppingCartId}')">
                                                    <i class="fa fa-trash-o ml-3 text-black-50"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                                            $('#apiDataContainer').append(strHTML);
                                                            totalPrice += items.priceArtwork;
                                                            $('#priceOrder').text(totalPrice.toLocaleString('vi-VN') + 'đ');
                                                            var totalPricePlus = totalPrice + 20000;
                                                            $('#totalPrice').text(totalPricePlus.toLocaleString('vi-VN') + 'đ');
                                                            $('#totalPrice2').text(totalPricePlus.toLocaleString('vi-VN') + 'đ');
                                                            sessionStorage.setItem('totalPriceOrder', totalPricePlus);
                                                        } else {
                                                            console.error('Invalid or empty response from the API.');
                                                        }
                                                    }
                                                });
                                            })(items); // Pass items to the closure
                                        });
                                    } else {
                                        console.error('Invalid or empty response from the API.');
                                    }
                                },
                                error: function (error) {
                                    console.error('Error:', error);
                                }
                            });
                        });
                        function deleteItems(cartId) {
                           
                                    $.ajax({
                                        type: 'DELETE',
                                        url: `https://localhost:7008/api/ShoppingCart/${cartId}`, // Replace with your actual API endpoint
                                        success: function (deleteResponse) {
                                            // Xử lý thành công từ phản hồi của API
                                            alert("DELETED!");
                                            // Tuỳ chọn: Đóng modal sau khi lưu thành công
                                            location.reload();
                                            
                                        },
                                        error: function (deleteError) {
                                            // Xử lý lỗi khi xóa
                                            alert(`Error deleting item with cartId ${cartId}:`, deleteError);

                                            // Hiển thị thông báo lỗi
                                           
                                        }
                                    });
                                }
                           
                    </script>



                </div>
            </div>
            <div class="col-md-4">
                <div class="payment-info" id="payment-info">
                    <label>Thông tin đặt hàng:</label>
                    <br>
                    <label for="Fullname">Tên:</label>
                    <input type="text" id="Fullname" class="form-control mb-2">
                    <label>  </label>
                    <label for="Phone">Số điện thoại:</label>
                    <input type="text" id="Phone" class="form-control mb-2">


                    <label for="Address">Địa chỉ nhận hàngg:</label>
                    <input type="text" id="Address" class="form-control mb-2">
                    <hr class="line">
                    <div class="d-flex justify-content-between information"><span>Tạm tính</span><span id="priceOrder"></span></div>
                    <div class="d-flex justify-content-between information"><span>Phí vận chuyển</span><span>30.000đ</span></div>
                    <div class="d-flex justify-content-between information"><span>Tổng</span><span id="totalPrice"></span></div>
                    <button onclick="Checkout()" class="btn btn-primary btn-block d-flex justify-content-between mt-3" type="button"><span id="totalPrice2"></span><span>Checkout<i class="fa fa-long-arrow-right ml-1"></i></span></button>

                </div>
            </div>
            <script>
                $(document).ready(function () {
                    $.ajax({
                        type: 'GET',
                        url: `https://localhost:7008/api/ShoppingCart/user/${userId}`,
                        
                        contentType: 'application/json', // Xác định loại nội dung gửi đi
                        success: function (response) {
                            // Xử lý kết quả trả về nếu cần
                            document.getElementById('count-items').innerText = "You have " + response.length + " items in your cart!";
                        },
                        error: function (error) {
                            document.getElementById('payment-info').style.display = 'none';
                        }
                    });
                });
               
                    function Checkout() {
                        var fullname = document.getElementById("Fullname").value;
                        var phone = document.getElementById("Phone").value;
                        var address = document.getElementById("Address").value;
                        var userId = sessionStorage.getItem("userId");

                        // Kiểm tra xem bất kỳ ô textbox nào có rỗng không
                        if (fullname === '' || phone === '' || address === '') {
                            // Nếu có một trong các ô textbox rỗng, hiển thị thông báo lỗi
                            alert('Vui lòng điền đầy đủ thông tin đặt hàng.');
                            return false; // Không thực hiện hàm tiếp theo
                        }

                        $.ajax({
                            type: 'GET',
                            url: `https://localhost:7008/api/ShoppingCart/user/${userId}`,
                            success: function (response) {
                                var orderDetailsArray = [];
                                var totalBill = 0;
                                // Lặp qua các phần tử trong mảng response để lấy thông tin và thêm vào mảng orderDetailsArray
                                response.forEach(function (item) {
                                    var orderDetail = {
                                        priceOrder: item.priceArtwork, // Giá đặt hàng
                                        artworkPId: item.artworkPId, // ID của sản phẩm
                                        quanity: item.quanity, // Số lượng
                                        address: address,
                                        phone: phone,
                                        fullName: fullname
                                    };
                                    orderDetailsArray.push(orderDetail);
                                    totalBill += item.priceArtwork;
                                });

                                // Tạo đối tượng dữ liệu theo định dạng JSON
                                var orderData = {
                                    orderDetails: orderDetailsArray,
                                    totalBill: totalBill + 30000,
                                    status: true
                                };

                                // Gửi dữ liệu qua API POST
                                $.ajax({
                                    type: 'POST',
                                    url: `https://localhost:7008/api/Order/CreateOrderV2?userid=${userId}`,
                                    data: JSON.stringify(orderData), // Chuyển đối tượng dữ liệu thành chuỗi JSON
                                    contentType: 'application/json', // Xác định loại nội dung gửi đi
                                    success: function (response2) {
                                        // Xử lý kết quả trả về nếu cần
                                        alert('DONE!');
                                        location.reload();
                                    },
                                    error: function (error) {
                                        console.error('Error:', error);
                                    }
                                });
                            },
                            error: function (error) {
                                console.error('Error:', error);
                            }
                        });
                    }
                
            </script>
        </div>
    </div>
</body>

</html>