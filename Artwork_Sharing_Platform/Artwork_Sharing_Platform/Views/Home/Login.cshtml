
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Login </title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--===============================================================================================-->
    <link rel="icon" type="image/png" href="~/Assets/Login/images/icons/favicon.ico" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/vendor/bootstrap/css/bootstrap.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/fonts/iconic/css/material-design-iconic-font.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/vendor/animate/animate.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/vendor/css-hamburgers/hamburgers.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/vendor/animsition/css/animsition.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/vendor/select2/select2.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/vendor/daterangepicker/daterangepicker.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/css/util.css">
    <link rel="stylesheet" type="text/css" href="~/Assets/Login/css/main.css">
    <!--===============================================================================================-->

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <style>
        #error-message {
            color: red;
            margin-top: 5px;
        }
        .tab-content {
            display: none;
        }

        .active-tab {
            display: block;
        }
    </style>
</head>
<body>

    


    <div class="limiter">
        <div class="container-login100" style="background-image: url('../../assets/login/images/bg-01.jpg');">
            <div class="wrap-login100 p-l-55 p-r-55 p-t-65 p-b-54">
                <div id="loginTab" class="tab-content active-tab">
                    <!-- Form đăng nhập -->
                    <form class="login100-form validate-form" method="post">
                        <span class="login100-form-title p-b-49">
                            Login
                        </span>

                        <div class="wrap-input100 validate-input m-b-23" data-validate="Username is required">
                            <span class="label-input100">Username</span>
                            <input class="input100" type="text" name="username" placeholder="Type your username">
                            <span class="focus-input100" data-symbol="&#xf206;"></span>
                        </div>

                        <div class="wrap-input100 validate-input" data-validate="Password is required">
                            <span class="label-input100">Password</span>
                            <input class="input100" type="password" name="password" placeholder="Type your password">
                            <span class="focus-input100" data-symbol="&#xf190;"></span>
                        </div>

                        <div id="error-message" class="text-danger"></div>

                        @if (ViewBag.Error != null)
                        {
                            <div class="alert alert-danger" role="alert">
                                @ViewBag.Error
                            </div>
                        }

                        <div class="text-right p-t-8 p-b-31">
                            <a href="#" onclick="showRegisterTab()">Don't have an account?, SIGN UP HERE</a>
                        </div>
                        <div class="text-right p-t-8 p-b-31">
                            <a href="#" onclick="showForgotPasswordTab()">Forgot password</a>
                        </div>

                        <div class="container-login100-form-btn">
                            <div class="wrap-login100-form-btn">
                                <div class="login100-form-bgbtn"></div>
                                <button class="login100-form-btn" onclick="SignIn()" type="submit">
                                    Login
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="registerTab" class="tab-content">
                    <!-- Form đăng ký -->
                    <form class="login100-form validate-form" method="post">
                        <!-- Các trường đăng ký, ví dụ: -->
                        <div class="wrap-input100 validate-input m-b-23" id="fullNameInput" data-validate="Full Name is required">
                            <span class="label-input100">Full Name</span>
                            <input class="input100" type="text" name="FullName" placeholder="Type your full name">
                            <span class="focus-input100" data-symbol="&#xf1ae;"></span>
                        </div>

                        <div class="wrap-input100 validate-input" id="phoneInput" data-validate="Phone is required">
                            <span class="label-input100">Phone</span>
                            <input class="input100" type="text" name="Phone" placeholder="Type your phone number">
                            <span class="focus-input100" data-symbol="&#xf2a0;"></span>
                        </div>

                        <div class="wrap-input100 validate-input" id="addressInput" data-validate="Address is required">
                            <span class="label-input100">Address</span>
                            <input class="input100" type="text" name="Address" placeholder="Type your address">
                            <span class="focus-input100" data-symbol="&#xf124;"></span>
                        </div>

                        <div class="wrap-input100 validate-input m-b-23" id="genderInput">
                            <span class="label-input100">Gender</span>
                            <select name="Gender" class="input100">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>

                        <div class="wrap-input100 validate-input m-b-23" id="birthdateInput" data-validate="Birthdate is required">
                            <span class="label-input100">Birthdate</span>
                            <input class="input100" type="date" name="Birthdate" placeholder="Select your birthdate">
                            <span class="focus-input100" data-symbol="&#xf1fd;"></span>
                        </div>

                        <div class="wrap-input100 validate-input m-b-23" id="emailInput" data-validate="Email is required">
                            <span class="label-input100">Email</span>
                            <input class="input100" type="email" name="accountEmail" placeholder="Type your email">
                            <span class="focus-input100" data-symbol="&#xf15a;"></span>

                        </div>

                        <div class="wrap-input100 validate-input" id="passwordInput" data-validate="Password is required">
                            <span class="label-input100">Password</span>
                            <input class="input100" type="password" name="accountPassword" placeholder="Type your password">
                            <span class="focus-input100" data-symbol="&#xf190;"></span>

                        </div>

                        <div class="wrap-input100 validate-input" id="confirmPasswordInput" data-validate="Confirm Password is required">
                            <span class="label-input100">Confirm Password</span>
                            <input class="input100" type="password" name="ConfirmAccountPassword" placeholder="Type your confirm password">
                            <span class="focus-input100" data-symbol="&#xf190;"></span>

                        </div>
                        <div class="text-right p-t-8 p-b-31">
                            <a href="#" onclick="showLoginTab()">Sign In</a>
                        </div>

                        <div class="container-login100-form-btn">
                            <div class="wrap-login100-form-btn">
                                <div class="login100-form-bgbtn"></div>
                                <button class="login100-form-btn" onclick="signUp()" type="submit">
                                    Sign Up
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="forgotPasswordTab" class="tab-content">
                    <!-- Form đăng ký -->
                    <div class="form-container">
                        <form class="login100-form validate-form" method="post">
                            <!-- Các trường đăng ký -->
                            <div class="wrap-input100 validate-input m-b-23" id="emailForgot" data-validate="Recover email required">
                                <span class="label-input100">Your Email</span>
                                <input class="input100" type="text" name="EmailF" placeholder="Type your email">
                                <span class="focus-input100" data-symbol="&#xf1ae;"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <div style="display: flex; align-items: center; justify-content: center;">
                                    <button class="button-inside-input" onclick="forgotPassword()">Send</button>
                                </div>
                                <div class="text-right p-t-8 p-b-31" style="margin-top: 30px">
                                    <a href="#" onclick="showLoginTab()">Sign In</a>
                                </div>
                            </div>
                            
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        function showForgotPasswordTab() {
            $('#loginTab').removeClass('active-tab');
            $('#registerTab').removeClass('active-tab');
            $('#forgotPasswordTab').addClass('active-tab');

        }
        function showRegisterTab() {
            $('#loginTab').removeClass('active-tab');
            $('#registerTab').addClass('active-tab');
            $('#forgotPasswordTab').removeClass('active-tab');
            $('#registerTab input[type="text"], #registerTab input[type="password"]').val('');
            $('#registerTab input[type="text"], #registerTab input[type="password"]').val('');
        }

        function showLoginTab() {
            $('#registerTab').removeClass('active-tab');
            $('#forgotPasswordTab').removeClass('active-tab');
            $('#loginTab').addClass('active-tab');
        }
        function signUp() {
            // Get values from input fields
            var fullName = document.getElementById('fullNameInput').querySelector('input[name="FullName"]').value;
            var phone = document.getElementById('phoneInput').querySelector('input[name="Phone"]').value;
            var address = document.getElementById('addressInput').querySelector('input[name="Address"]').value;
            var genderSelect = document.getElementById('genderInput').querySelector('select[name="Gender"]');
            var genderValue = genderSelect.options[genderSelect.selectedIndex].value;
            var gender = genderValue === 'Male'
            var birthdate = document.getElementById('birthdateInput').querySelector('input[name="Birthdate"]').value;
            var email = document.getElementById('emailInput').querySelector('input[name="accountEmail"]').value;
            var password = document.getElementById('passwordInput').querySelector('input[name="accountPassword"]').value;
            var confirmPassword = document.getElementById('confirmPasswordInput').querySelector('input[name="ConfirmAccountPassword"]').value;

            if (fullName.trim() === '') {
                alert('Please enter your full name.');
            } else if (address.trim() === '') {
                alert('Please enter your address.');
            } else if (birthdate.trim() === '') {
                alert('Please select your birthdate.');
            } else if (phone.trim().length !== 10) {
                alert('Phone number must be 10 digits.');
            } else {
                $.ajax({
                    type: 'POST',
                    url: 'https://localhost:7008/api/Person/SignUpPerson', // Replace with your actual API endpoint
                    data: JSON.stringify({
                        accountPhone: phone,
                        fullName: fullName,
                        gender: gender,
                        address: address,
                        accountEmail: email,
                        birthDate: convertDateFormat(birthdate),
                        accountPassword: password,
                        confirmAccountPassword: confirmPassword
                    }),

                    contentType: 'application/json',
                    success: function (data) {
                        // Handle success response from the API
                        alert("SIGN UP DONE!");
                        // Optionally, close the modal after successful save
                        showLoginTab();


                    },
                    error: function (xhr, status, error) {
                        // Handle error response from the API
                        var response = xhr.responseJSON;
                        if (response && response.status === 'Hihi') {
                            // Display error message to the user
                            alert(response.message);
                        } else {
                            // Handle other error scenarios
                            alert('An error occurred during sign up. Please try again later.');
                        }
                    }
                });
            };

            // Read the image file as a data URL
        }

        function convertDateFormat(inputDate) {
            // Phân tích chuỗi ngày tháng thành mảng [MM, DD, YYYY]
            var dateArray = inputDate.split('-');

            // Tạo đối tượng Date với định dạng MM-DD-YYYY
            var originalDate = new Date(dateArray[2], dateArray[0] - 1, dateArray[1]);

            // Lấy các thành phần ngày tháng năm
            var year = originalDate.getFullYear();
            var month = (originalDate.getMonth() + 1).toString().padStart(2, '0'); // Cộng thêm 1 vì tháng trong JavaScript bắt đầu từ 0
            var day = originalDate.getDate().toString().padStart(2, '0');

            // Tạo chuỗi mới theo định dạng YYYY-MM-DD
            var newDateFormat = year + '-' + month + '-' + day;

            return newDateFormat;
        }

    </script>
    @*<div class="limiter">
            <div class="container-login100" style=" background-image: url('../../assets/login/images/bg-01.jpg');">
                <div class="wrap-login100 p-l-55 p-r-55 p-t-65 p-b-54">
                    <form class="login100-form validate-form" method="post">
                        <span class="login100-form-title p-b-49">
                            Login
                        </span>


                        <div class="wrap-input100 validate-input m-b-23" data-validate="Username is required">
                            <span class="label-input100">Username</span>
                            <input class="input100" type="text" name="username" placeholder="Type your username">
                            <span class="focus-input100" data-symbol="&#xf206;"></span>
                        </div>

                        <div class="wrap-input100 validate-input" data-validate="Password is required">
                            <span class="label-input100">Password</span>
                            <input class="input100" type="password" name="password" placeholder="Type your password">
                            <span class="focus-input100" data-symbol="&#xf190;"></span>
                        </div>

                        <div id="error-message" class="text-danger"></div>

                        @if (ViewBag.Error != null)
                        {
                            <div class="alert alert-danger" role="alert">
                                @ViewBag.Error
                            </div>
                        }
                        <div class="text-right p-t-8 p-b-31">
                            <a href="#">
                                Forgot password?
                            </a>
                        </div>

                        <div class="container-login100-form-btn">
                            <div class="wrap-login100-form-btn">
                                <div class="login100-form-bgbtn"></div>
                                <button class="login100-form-btn" type="submit">
                                    Login
                                </button>
                            </div>
                        </div>

                        <div class="txt1 text-center p-t-54 p-b-20">
                            <span>
                                Or Sign Up Using
                            </span>
                        </div>

                        <div class="flex-c-m">
                            <a href="#" class="login100-social-item bg1">
                                <i class="fa fa-facebook"></i>
                            </a>



                            <a href="#" class="login100-social-item bg3">
                                <i class="fa fa-google"></i>
                            </a>
                        </div>

                        <div class="flex-col-c p-t-155">
                            <span class="txt1 p-b-17">
                                Or Sign Up Using
                            </span>

                            <a href="#" class="txt2">
                                Sign Up
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>*@
<script>

    function forgotPassword() {
        var email = document.querySelector('#emailForgot input[name="EmailF"]').value;

        if (email) {
            var forgotPasswordData = {
                email: email
            };

            $.ajax({
                type: 'POST',
                url: 'https://localhost:7008/api/Person/ForgetPasswordAsync',
                contentType: 'application/json',
                data: JSON.stringify(forgotPasswordData),
                success: function (data) {
                    // Handle success response from the API
                    alert("Verification email sent. Please check your email.");


                },
                error: function (xhr, status, error) {
                    //console.error('An error occurred while sending password reset request. Status:', xhr.status);
                    //swal("Error", "An error occurred while sending password reset request", "error");
                    alert("Email does not exist.");
                }
            });
        }
    }










    function confirmEmail() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const email = urlParams.get('email');


        console.log('code: ', code);
        console.log('email: ', email);

        console.log('encode code: ', encodeURIComponent(code));

        if (code && email) {
            $.ajax({
                url: `https://localhost:7008/api/Person/ConfirmEmailAsync?email=${email}&token=${encodeURIComponent(code)}`,
                method: 'POST',
                success: function (result) {
                    console.log('API Response:', result);
                    if (result.status === "Success") {
                        $('#error-message').text('Email đã được xác thực thành công');
                    } else {
                        $('#error-message').text('Xác thực email thất bại');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('An error occurred during email confirmation. Status:', xhr.status);
                    $('#error-message').text('An error occurred during email confirmation');
                }
            });
        }
    }

    $(document).ready(confirmEmail);








        /*đã fix code hiển thị đúng lỗi ở phía api*/

        function SignIn() {
            $('form').submit(function (e) {
                e.preventDefault();

                var username = $('input[name="username"]').val();
                var password = $('input[name="password"]').val();
            
                var loginData = {
                    accountEmail: username,
                    accountPassword: password
                };

                $.ajax({
                    type: 'POST',
                    url: 'https://localhost:7008/api/Person/SignIn',
                    contentType: 'application/json',
                    data: JSON.stringify(loginData),
                    success: function (data) {
                        handleLoginSuccess(data);
                    },
                    error: function (xhr) {
                        handleLoginError(xhr);
                    }
                });
            });
        }

        function handleLoginSuccess(data) {
            var JwtToken = data.jwtToken;
            var decodedToken = parseJwt(JwtToken);
            var userEmail = decodedToken['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name'];
            sessionStorage.setItem('userEmail', userEmail);
            sessionStorage.setItem('jwtToken', JwtToken);
           
            var storedUserEmail = sessionStorage.getItem('userEmail');
          
           
        
            checkUserRole(storedUserEmail, decodedToken);
        }

        function handleLoginError(xhr) {
            var response = xhr.responseJSON;

            if (response && response.errors && response.errors[""]) {
                var errorMessage = response.errors[""][0]; // Lỗi tương ứng trả về từ API controller

                $('#error-message').text(errorMessage).show();
            } else {
                var errorMessage = xhr.responseText;

                if (errorMessage) {
                    $('#error-message').text(errorMessage).show();
                } else {
                    $('#error-message').text('An error occurred during login. Please try again later.').show();
                }
            }
        }

        //function SignIn() {
        //    // Attach an event listener to the form submission
        //    $('form').submit(function (e) {
        //        e.preventDefault(); // Prevent the default form submission

        //        // Get the username and password from the form
        //        var username = $('input[name="username"]').val();
        //        var password = $('input[name="password"]').val();

        //        // Create the login data object
        //        var loginData = {
        //            accountEmail: username,
        //            accountPassword: password
        //        };

        //        // Make an Ajax request to the login API
        //        $.ajax({
        //            type: 'POST',
        //            url: 'https://localhost:7008/api/Person/SignIn',
        //            contentType: 'application/json',
        //            data: JSON.stringify(loginData),
        //            success: function (data) {
        //                handleLoginSuccess(data);
        //            },
        //            error: function (xhr, status, error) {
        //                handleLoginError(xhr);
        //            }
        //        });
        //    });
        //}

        //// Function to handle the success of the login AJAX request
        //function handleLoginSuccess(data) {
        //    // If login is successful, handle the JWT token
        //    var JwtToken = data.jwtToken;

        //    // Decode the JWT token to get user information, including roles
        //    var decodedToken = parseJwt(JwtToken);
        //    var userEmail = decodedToken['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name'];
        //    sessionStorage.setItem('userEmail', userEmail);

        //    // Truy xuất thông tin người dùng từ sessionStorage ở các trang HTML khác
        //    var storedUserEmail = sessionStorage.getItem('userEmail');
        //    console.log(storedUserEmail);

        //    // Check the user's role with a separate AJAX request
        //    checkUserRole(storedUserEmail, decodedToken);
        //}

        //// Function to handle the error of the login AJAX request
        //function handleLoginError(xhr) {
        //    console.log('Login error: ', xhr.responseText);

        //    if (xhr.status === 401) {
        //        // Display an error message for incorrect username or password
        //        $('#error-message').text('Incorrect username or password. Please try again.').show();
        //        $('input[name="pass"]').val('');
        //    } else {
        //        // Handle other error scenarios
        //        $('#error-message').text('An error occurred during login. Please try again later.').show();
        //    }
        //}












        // Function to check the user's role with a separate AJAX request
        function checkUserRole(storedUserEmail, decodedToken) {
            $.ajax({
                type: 'GET',
                url: `https://localhost:7008/api/Person/email?email=${storedUserEmail}`,
                success: function (response) {
                    // Hiển thị dữ liệu từ API lên trang
                    var userID = response.id;
                    sessionStorage.setItem('userId', userID);
                    console.log(sessionStorage.getItem('userId'));
                    sessionStorage.setItem('avatar', response.avatar);

                    // Redirect based on user role
                    redirectBasedOnUserRole(decodedToken);
                },
                error: function (error) {
                    console.error('Lỗi:', error);
                }
            });
        }

        // Function to redirect based on user role
        function redirectBasedOnUserRole(decodedToken) {
            if (decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] &&
                decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'].includes('Audience')) {
                // Redirect to page a
                window.location.href = '/Audience/Manage/Manage'.replace('/Home', '');
            } else if (decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] &&
                decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'].includes('Admin')) {
                window.location.href = '/Admin/Manage/AdminPage'.replace('/Home', '');
            } else if (decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] &&
                decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'].includes('SuperAdmin')) {
                window.location.href = '/Admin/Manage/AdminPage'.replace('/Home', '');
            } else {
                // Handle other roles or scenarios
                console.log('Unknown role or scenario');
            }
        }
        // Function to parse the JWT token
    function parseJwt(token) {

            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

    document.addEventListener('DOMContentLoaded', function () {
        var jwtToken = sessionStorage.getItem('jwtToken');
        if (jwtToken !== null) {
            console.log(jwtToken);
            var decodedtoken = parseJwt(jwtToken);
            redirectBasedOnUserRole(decodedtoken);
        }
        
    });
   

    </script>

    <div id="dropDownSelect1"></div>

    <!--===============================================================================================-->
    <script src="~/Assets/Login/vendor/jquery/jquery-3.2.1.min.js"></script>
    <!--===============================================================================================-->
    <script src="~/Assets/Login/vendor/animsition/js/animsition.min.js"></script>
    <!--===============================================================================================-->
    <script src="~/Assets/Login/vendor/bootstrap/js/popper.js"></script>
    <script src="~/Assets/Login/vendor/bootstrap/js/bootstrap.min.js"></script>
    <!--===============================================================================================-->
    <script src="~/Assets/Login/vendor/select2/select2.min.js"></script>
    <!--===============================================================================================-->
    <script src="~/Assets/Login/vendor/daterangepicker/moment.min.js"></script>
    <script src="~/Assets/Login/vendor/daterangepicker/daterangepicker.js"></script>
    <!--===============================================================================================-->
    <script src="~/Assets/Login/vendor/countdowntime/countdowntime.js"></script>
    <!--===============================================================================================-->
    <script src="~/Assets/Login/js/main.js"></script>

</body>
</html>