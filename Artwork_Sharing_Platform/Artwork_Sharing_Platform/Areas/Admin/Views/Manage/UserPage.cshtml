
@{
    ViewBag.Title = "UserPage";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdminPage.cshtml";
}

<h2>UserPage</h2>

<div id="page-wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">UserPage</h1>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-lg-12">
                    <div class="table-responsive">
                        <table id="transactionTable" class="table table-bordered table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Full Name</th>
                                    <th>Gender</th>
                                    <th>Email</th>
                                    <th>Phone Number</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <!-- /.table-responsive -->
                </div>
            </div>
        </div>
    </div>
    </div>
<script>
   
    fetch('https://localhost:7008/api/Person/GetAllAccountByAdmin')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#transactionTable tbody');

            data.dataObject.forEach((transaction, index) => {
                const row = document.createElement('tr');

                const idCell = document.createElement('td');
                idCell.textContent = index + 1;
                row.appendChild(idCell);

                const userIdCell = document.createElement('td');
                userIdCell.textContent = transaction.fullName;
                row.appendChild(userIdCell);

                const descriptionCell = document.createElement('td');
                descriptionCell.textContent = transaction.gender ? "Male" : "Female";
                row.appendChild(descriptionCell);

                const statusCell = document.createElement('td');
                statusCell.textContent = transaction.email;
                row.appendChild(statusCell);

                const actionCell = document.createElement('td');

               

                actionCell.textContent = transaction.phoneNumber;
                

                row.appendChild(actionCell);
                tbody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching transactions:', error));

    function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }
    document.addEventListener('DOMContentLoaded', function () {
        var storedUserEmail = sessionStorage.getItem('userEmail');
        // Thực hiện đăng xuất sau 5 giây
        var sessionTimeout = 3600000;
        setTimeout(function () {
            // Xóa thông tin phiên đăng nhập khi hết thời gian
            sessionStorage.removeItem('userEmail');

            // Chuyển hướng đến trang đăng nhập
            window.location.href = 'https://localhost:44321/Home/Login';
        }, sessionTimeout);

        if (storedUserEmail === null) {
            // Chuyển hướng đến trang đăng nhập
            window.location.href = 'https://localhost:44321/Home/Login'; // Thay đổi đường dẫn tương ứng với trang đăng nhập của bạn
            return;
        }
        console.log(storedUserEmail);
        $.ajax({
            type: 'GET',
            url: `https://localhost:7008/api/Person/email?email=${storedUserEmail}`,
            success: function (response) {
                // Hiển thị dữ liệu từ API lên trang
                //var JwtToken = response.jwtToken;
                //var decodedToken = parseJwt(JwtToken);
                //redirectBasedOnUserRole(decodedToken);
                console.log(response);
            },
            error: function (error) {
                console.error('Lỗi:', error);
            }
        });
    });
    function redirectBasedOnUserRole(decodedToken) {
        if (decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] &&
            decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'].includes('Audience')) {
            // Redirect to page a
            window.location.href = '/Audience/Manage/Manage'.replace('/Home', '');
        
        } else if (decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] &&
            decodedToken['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'].includes('SuperAdmin')) {
            window.location.href = '/Admin/Manage/UserPageBySuperAdmin'.replace('/Home', '');
        } else {
            // Handle other roles or scenarios
            console.log('Unknown role or scenario');
        }
    }


    
</script>
