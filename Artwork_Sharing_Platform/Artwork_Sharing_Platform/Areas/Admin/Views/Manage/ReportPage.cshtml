
@{
    ViewBag.Title = "ReportPage";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdminPage.cshtml";
}

<h2>ReportPage</h2>

<div id="page-wrapper">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">ReportPage</h1>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-lg-12">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="input-group custom-search-form col-lg-12">
                                <input type="text" id="searchInput" class="form-control" placeholder="Search..." onkeyup="searchTable()">
                                <span class="input-group-btn">
                                    <button class="btn btn-primary" type="button" onclick="searchTable()">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </span>
                            </div>
                        </div>

                    </div>
                    <div class="table-responsive">
                        <table id="transactionTable" class="table table-bordered table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Report ID</th>
                                    <th>Artwork ID</th>
                                    <th>User ID</th>
                                    <th>Description</th>
                                    <th>Action</th>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <!-- /.table-responsive -->

                </div>
            </div>
        </div>
    </div>
</div>
<script>

    document.addEventListener('DOMContentLoaded', function () {
        fetchDataAndShowInTable();
    });

    async function fetchDataAndShowInTable() {
        try {
            const response = await fetch("https://localhost:7008/api/Report/GetAllReport");
            const data = await response.json();
            console.log(data);

            const tbody = document.querySelector('#transactionTable tbody');
            tbody.innerHTML = "";

            data.forEach(report => {
                const row = document.createElement('tr');

                row.innerHTML = `
                <td>${report.reportId}</td>
                <td>${report.artworkPId || ''}</td>
                <td>${report.userId || ''}</td>
                <td>${report.description || ''}</td>

            `;

                if (report.status) {
                    const acceptButton = document.createElement('button');
                    acceptButton.textContent = "Accept Report";
                    acceptButton.className = "btn btn-primary";

                    acceptButton.addEventListener('click', function () {
                        acceptReport(report.reportId);
                    });

                    const acceptButtonCell = document.createElement('td');
                    acceptButtonCell.appendChild(acceptButton);
                    row.appendChild(acceptButtonCell);
                } else {
                    const disabledCell = document.createElement('td');
                    row.appendChild(disabledCell);
                }

                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    async function acceptReport(reportId) {
        const url = `https://localhost:7008/api/Report/UpdateReport`;
        const params = new URLSearchParams({ reportId });

        fetch(url + '?' + params.toString(), {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'Success') {
                    console.log('Report accepted successfully');
                    const row = document.getElementById(`report-${reportId}`);
                    if (row) {
                        let cell = row.querySelector('td:last-child');
                        if (!cell) {
                            cell = document.createElement('td');
                            row.appendChild(cell);
                        }
                        cell.textContent = 'Accepted';
                        cell.className = 'text-success';
                    }
                    window.location.reload();
                } else {
                    console.error('Error accepting report:', data.message);
                }
            })
            .catch(error => console.error('Error accepting report:', error));
    }

    // Function to search the table based on input value
    function searchTable() {
        // Get the input value
        const inputValue = document.getElementById("searchInput").value.toLowerCase();

        // Get all table rows
        const tableRows = document.querySelectorAll("#transactionTable tbody tr");

        // Loop through the rows and hide/show based on input value
        tableRows.forEach((row) => {
            const reportIdCell = row.children[0];
            const artworkIdCell = row.children[1];
            const userIdCell = row.children[2];

            const reportIdText = reportIdCell.textContent.toLowerCase();
            const artworkIdText = artworkIdCell.textContent.toLowerCase();
            const userIdText = userIdCell.textContent.toLowerCase();

            const showRow =
                reportIdText.includes(inputValue) ||
                artworkIdText.includes(inputValue) ||
                userIdText.includes(inputValue);

            // Toggle visibility of the row
            row.style.display = showRow ? "" : "none";
        });
    }
</script>